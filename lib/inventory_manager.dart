import 'dart:async';
import 'dart:io';
import 'package:path_provider/path_provider.dart';
import 'package:google_mlkit_text_recognition/google_mlkit_text_recognition.dart';
import 'dart:convert';
import 'image_preview.dart';

class InventoryManager {
  InventoryManager._privateConstructor() {
    List<String> JSON = [
    "{\"Coca-Cola\": {\"label\":\"Drink\",\"name\":\"Coca-Cola\",\"description\":\"A refreshing sip of deliciousness, a taste to savour.\",\"imagePath\":\"\/data\/user\/0\/com.example.hack_the_north2024\/cache\/ec78bfdc-01cc-4571-ae26-5fa376e6f9245922340158272114301.jpg\",\"nutrients\":[{\"name\":\"Calories\",\"description\":\"Energy content of the food.\",\"value\":140,\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Fat\",\"description\":\"This product contains no fat.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Carbohydrates\",\"description\":\"High carbohydrate content may increase blood sugar levels.\",\"value\":\"39 g\",\"measure\":\"high\",\"type\":\"unhealthy\"},{\"name\":\"Sugars\",\"description\":\"High sugar content may increase the risk of diabetes.\",\"value\":\"39 g\",\"measure\":\"high\",\"type\":\"unhealthy\"},{\"name\":\"Protein\",\"description\":\"Protein is essential for muscle growth and repair.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"moderate\"},{\"name\":\"Sodium\",\"description\":\"Low sodium content is healthy.\",\"value\":\"25 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Potassium\",\"description\":\"Potassium is essential for nerve and muscle function.\",\"value\":\"10 mg\",\"measure\":\"low\",\"type\":\"healthy\"}],\"ingredients\":[{\"name\":\"Carbonated water\",\"description\":\"A good alternative to sugary drinks, but excessive intake may reduce bone density.\",\"rating\":7},{\"name\":\"Sugar\/glucose-fructose\",\"description\":\"Consume sugars in moderation to avoid weight gain and diabetes.\",\"rating\":5},{\"name\":\"Caramel colour\",\"description\":\"May contain 4-Methylimidazole (4-MEI), a potential carcinogen.\",\"rating\":4},{\"name\":\"Phosphoric acid\",\"description\":\"May contribute to tooth erosion and bone density loss.\",\"rating\":4},{\"name\":\"Natural flavour\",\"description\":\"May contain hidden allergens and natural chemicals with health risks.\",\"rating\":6},{\"name\":\"Caffeine\",\"description\":\"Stimulant that may improve focus but can cause anxiety and sleep issues.\",\"rating\":6}]}}",
    "{\"Cheetos\": {\"label\":\"Cheese\",\"name\":\"Cheetos\",\"description\":\"A cheesy delight, sealed with a promise of authenticity.\",\"imagePath\":\"\/data\/user\/0\/com.example.hack_the_north2024\/cache\/0fc3b4ea-4fc7-463c-ae45-8ae35ecb59471738532077936826555.jpg\",\"nutrients\":[{\"name\":\"Calories\",\"description\":\"Provides energy for daily activities.\",\"value\":160,\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Fat\",\"description\":\"Moderate fat content, but may increase heart disease risk.\",\"value\":\"10 g\",\"measure\":\"moderate\",\"type\":\"unhealthy\"},{\"name\":\"Saturated\",\"description\":\"Low saturated fat is beneficial for heart health.\",\"value\":\"1.5 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Trans\",\"description\":\"No trans fat is ideal for a healthy diet.\",\"value\":\"0.1 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Carbohydrates\",\"description\":\"Carbs provide energy, but high intake may impact blood sugar.\",\"value\":\"15 g\",\"measure\":\"moderate\",\"type\":\"moderate\"},{\"name\":\"Fibre\",\"description\":\"Fibre aids digestion and supports a healthy gut.\",\"value\":\"1 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Sugars\",\"description\":\"Low sugar content is beneficial for overall health.\",\"value\":\"2 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Protein\",\"description\":\"Essential for muscle repair and growth.\",\"value\":\"2 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Sodium\",\"description\":\"Moderate sodium intake is recommended for blood pressure control.\",\"value\":\"250 mg\",\"measure\":\"moderate\",\"type\":\"moderate\"},{\"name\":\"Potassium\",\"description\":\"Potassium supports nerve and muscle function.\",\"value\":\"50 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Calcium\",\"description\":\"Important for bone health and muscle function.\",\"value\":\"20 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Iron\",\"description\":\"Iron is essential for oxygen transport in the blood.\",\"value\":\"0.75 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Cholesterol\",\"description\":\"No cholesterol is ideal for heart health.\",\"value\":\"0 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Thiamine\",\"description\":\"Thiamine supports energy metabolism and nerve function.\",\"value\":\"0.1 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Riboflavin\",\"description\":\"Riboflavin is vital for energy production and growth.\",\"value\":\"0.1 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Niacin\",\"description\":\"Niacin supports healthy skin and nervous system function.\",\"value\":\"1 mg\",\"measure\":\"low\",\"type\":\"healthy\"}],\"ingredients\":[{\"name\":\"Enriched cornmeal\",\"description\":\"Fortified with vitamins and minerals, but may be highly processed.\",\"rating\":6},{\"name\":\"Cornmeal\",\"description\":\"A good source of complex carbohydrates and fibre.\",\"rating\":7},{\"name\":\"Niacin\",\"description\":\"Vitamin B3, essential for energy metabolism and skin health.\",\"rating\":8},{\"name\":\"Iron\",\"description\":\"Crucial for oxygen transport and energy production.\",\"rating\":9},{\"name\":\"Thiamine mononitrate\",\"description\":\"Vitamin B1, vital for nerve function and carbohydrate metabolism.\",\"rating\":8},{\"name\":\"Riboflavin\",\"description\":\"Vitamin B2, supports energy production and healthy vision.\",\"rating\":8},{\"name\":\"Folic acid\",\"description\":\"A B vitamin essential for DNA synthesis and pregnancy health.\",\"rating\":8},{\"name\":\"Vegetable oil\",\"description\":\"Highly processed, may raise inflammation and contain unhealthy fats.\",\"rating\":4},{\"name\":\"Seasoning\",\"description\":\"Contains dairy, artificial flavours, and high sodium content.\",\"rating\":4},{\"name\":\"Modified milk ingredients\",\"description\":\"Processed dairy, may cause issues for lactose-intolerant individuals.\",\"rating\":5},{\"name\":\"Cheddar cheese\",\"description\":\"A good source of calcium and protein, but high in saturated fat.\",\"rating\":6},{\"name\":\"Maltodextrin\",\"description\":\"Highly processed. Dangerous for diabetics and those with gluten allergies.\",\"rating\":3},{\"name\":\"Salt\",\"description\":\"Excessive intake increases the risk of high blood pressure and heart disease.\",\"rating\":5},{\"name\":\"Monosodium glutamate\",\"description\":\"May cause headaches and other side effects in sensitive individuals.\",\"rating\":3},{\"name\":\"Lactic acid\",\"description\":\"May help improve gut health and digestion.\",\"rating\":7},{\"name\":\"Citric acid\",\"description\":\"May help prevent kidney stones and improve iron absorption.\",\"rating\":7},{\"name\":\"Sunset yellow FCF\",\"description\":\"May cause allergic reactions and hyperactivity, especially in children.\",\"rating\":1},{\"name\":\"Natural and artificial flavour\",\"description\":\"May contain hidden allergens and harmful chemicals.\",\"rating\":4}]}}",
    "{\"Oasis Apple Grape Blend\": {\"label\":\"Juice\",\"name\":\"Oasis Apple Grape Blend\",\"description\":\"A juicy blend of apples and grapes, a fruity adventure awaits!\",\"imagePath\":\"\/data\/user\/0\/com.example.hack_the_north2024\/cache\/d74ead34-87e9-4d52-808d-6cbda8b775bf8275201582581116699.jpg\",\"nutrients\":[{\"name\":\"Calories\",\"description\":\"A moderate amount of energy, suitable for a small snack.\",\"value\":80,\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Fat\",\"description\":\"Fat-free product, reducing the risk of heart disease.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Saturated\",\"description\":\"No saturated fat, a healthy choice.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Trans\",\"description\":\"No trans fat, a positive feature.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Carbohydrates\",\"description\":\"Moderate carbs, providing energy without excess.\",\"value\":\"21 g\",\"measure\":\"moderate\",\"type\":\"healthy\"},{\"name\":\"Fibre\",\"description\":\"No fibre, which could be improved for digestive health.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"unhealthy\"},{\"name\":\"Sugars\",\"description\":\"High sugar content, a concern for dental and general health.\",\"value\":\"19 g\",\"measure\":\"high\",\"type\":\"unhealthy\"},{\"name\":\"Sodium\",\"description\":\"Very low sodium, a positive aspect.\",\"value\":\"15 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Protein\",\"description\":\"No protein, which may limit its ability to satisfy hunger.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"unhealthy\"},{\"name\":\"Cholesterol\",\"description\":\"Cholesterol-free, a healthy feature.\",\"value\":\"0 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Potassium\",\"description\":\"Provides a small amount of potassium, essential for nerve function.\",\"value\":\"125 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Calcium\",\"description\":\"A small amount of calcium, important for bone health.\",\"value\":\"30 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Iron\",\"description\":\"Very low in iron, which is crucial for blood health.\",\"value\":\"0.1 mg\",\"measure\":\"low\",\"type\":\"unhealthy\"},{\"name\":\"Vitamin C\",\"description\":\"High in Vitamin C, an excellent source for immune support.\",\"value\":\"48 mg\",\"measure\":\"high\",\"type\":\"healthy\"}],\"ingredients\":[{\"name\":\"Fruit juice from concentrate (water, concentrated apple and grape juices)\",\"description\":\"Contains vitamins and antioxidants, but may have high sugar content.\",\"rating\":7},{\"name\":\"Vitamin C\",\"description\":\"An essential nutrient for immune function and collagen synthesis.\",\"rating\":9},{\"name\":\"Natural flavour\",\"description\":\"May be derived from natural sources, but can be highly processed.\",\"rating\":6}]}}",
    "{\"Oasis Orange Juice\": {\"label\":\"Juice\",\"name\":\"Oasis Orange Juice\",\"description\":\"A pure, tangy breakfast blend to kickstart your day!\",\"imagePath\":\"\/data\/user\/0\/com.example.hack_the_north2024\/cache\/a9dd69b5-0752-4c2b-88c3-5b67520dd62a8131621359265923520.jpg\",\"nutrients\":[{\"name\":\"Calories\",\"description\":\"Provides energy for daily activities.\",\"value\":80,\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Fat\",\"description\":\"This product is fat-free, reducing the risk of heart disease.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Saturated\",\"description\":\"No saturated fat, which is beneficial for heart health.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Trans\",\"description\":\"No trans fats, a healthy choice for your diet.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Carbohydrates\",\"description\":\"Moderate amount of carbs, providing energy.\",\"value\":\"20 g\",\"measure\":\"moderate\",\"type\":\"healthy\"},{\"name\":\"Sugars\",\"description\":\"High in natural fruit sugars, a healthier option.\",\"value\":\"18 g\",\"measure\":\"high\",\"type\":\"moderate\"},{\"name\":\"Protein\",\"description\":\"Contains no protein, an essential nutrient for muscle health.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"unhealthy\"},{\"name\":\"Sodium\",\"description\":\"Very low sodium content, a positive aspect for blood pressure.\",\"value\":\"15 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Cholesterol\",\"description\":\"Cholesterol-free, promoting a healthy heart.\",\"value\":\"0 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Potassium\",\"description\":\"Provides a moderate amount of potassium, essential for nerve function.\",\"value\":\"225 mg\",\"measure\":\"moderate\",\"type\":\"healthy\"},{\"name\":\"Calcium\",\"description\":\"A small amount of calcium, crucial for bone health.\",\"value\":\"30 mg\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Iron\",\"description\":\"Very low in iron, an important mineral for blood health.\",\"value\":\"0.1 mg\",\"measure\":\"low\",\"type\":\"unhealthy\"},{\"name\":\"Vitamin C\",\"description\":\"High in Vitamin C, supporting immune function.\",\"value\":\"48 mg\",\"measure\":\"high\",\"type\":\"healthy\"}],\"ingredients\":[{\"name\":\"Fruit juice from concentrate\",\"description\":\"Contains natural sugars and vitamins, but may have added sulfites.\",\"rating\":7},{\"name\":\"Water\",\"description\":\"Essential for hydration, but may contain added minerals.\",\"rating\":9},{\"name\":\"Orange, apple, and\/or grape juices\",\"description\":\"Natural fruit sugars and vitamins, but may contain sulfites.\",\"rating\":8},{\"name\":\"Citric acid\",\"description\":\"Natural acid found in citrus fruits, used as a preservative.\",\"rating\":7},{\"name\":\"Vitamin C\",\"description\":\"An essential vitamin with antioxidant properties.\",\"rating\":9},{\"name\":\"Natural flavour\",\"description\":\"Derived from natural sources, but may be highly processed.\",\"rating\":6}]}}",
    "{\"Monster\": {\"label\":\"Drink\",\"name\":\"Monster\",\"description\":\"A mysterious beverage, ready to quench your thirst and curiosity!\",\"imagePath\":\"\/data\/user\/0\/com.example.hack_the_north2024\/cache\/c2a79cd6-2a80-4a02-8f57-96ad38c965f55234605788376969711.jpg\",\"nutrients\":[{\"name\":\"Calories\",\"description\":\"Energy provided by the drink, which can be used to fuel bodily functions.\",\"value\":210,\"measure\":\"moderate\",\"type\":\"healthy\"},{\"name\":\"Fat\",\"description\":\"This product contains no fat, which is beneficial for heart health.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"healthy\"},{\"name\":\"Sodium\",\"description\":\"High sodium intake may lead to increased blood pressure.\",\"value\":\"370 mg\",\"measure\":\"high\",\"type\":\"unhealthy\"},{\"name\":\"Carbohydrates\",\"description\":\"Carbohydrates provide energy, but excess may lead to weight gain.\",\"value\":\"55 g\",\"measure\":\"high\",\"type\":\"moderate\"},{\"name\":\"Sugars\",\"description\":\"High sugar content can impact dental health and blood sugar levels.\",\"value\":\"54 g\",\"measure\":\"high\",\"type\":\"unhealthy\"},{\"name\":\"Protein\",\"description\":\"Protein is essential for muscle repair and growth, but this product has none.\",\"value\":\"0 g\",\"measure\":\"low\",\"type\":\"moderate\"},{\"name\":\"Riboflavin\",\"description\":\"Riboflavin is important for energy production and overall health.\",\"value\":\"15 % daily value\",\"measure\":\"high\",\"type\":\"healthy\"},{\"name\":\"Niacin\",\"description\":\"Niacin supports healthy skin and digestion, and this product provides a good amount.\",\"value\":\"210 % daily value\",\"measure\":\"high\",\"type\":\"healthy\"},{\"name\":\"Vitamin B6\",\"description\":\"Vitamin B6 is crucial for brain health and metabolism.\",\"value\":\"220 % daily value\",\"measure\":\"high\",\"type\":\"healthy\"},{\"name\":\"Vitamin B12\",\"description\":\"Vitamin B12 is essential for nerve function and red blood cell formation.\",\"value\":\"590 % daily value\",\"measure\":\"high\",\"type\":\"healthy\"},{\"name\":\"Caffeine\",\"description\":\"High caffeine content. May cause increased alertness but can lead to jitters and disrupted sleep.\",\"value\":\"168 mg\",\"measure\":\"high\",\"type\":\"moderate\"},{\"name\":\"Taurine\",\"description\":\"An amino acid that supports neurological development and heart health.\",\"value\":\"2000 mg\",\"measure\":\"high\",\"type\":\"healthy\"},{\"name\":\"Grape Skin Extract\",\"description\":\"Contains antioxidants, which can reduce cell damage and inflammation.\",\"value\":\"500 mg\",\"measure\":\"moderate\",\"type\":\"healthy\"},{\"name\":\"Lactone\",\"description\":\"A compound with potential health benefits, but more research is needed.\",\"value\":\"10 mg\",\"measure\":\"low\",\"type\":\"moderate\"},{\"name\":\"Sucralose\",\"description\":\"A zero-calorie sweetener, but may impact gut health and blood sugar regulation.\",\"value\":\"20 mg\",\"measure\":\"low\",\"type\":\"moderate\"}],\"ingredients\":[{\"name\":\"Carbonated water\",\"description\":\"Carbonated water is a good alternative to sugary drinks, but excessive intake may reduce bone density.\",\"rating\":7},{\"name\":\"Sugar\",\"description\":\"Consume sugars in moderation to avoid weight gain and diabetes.\",\"rating\":5},{\"name\":\"Glucose\",\"description\":\"Glucose is a simple sugar, quickly absorbed by the body. It provides a rapid energy boost.\",\"rating\":5},{\"name\":\"Citric acid\",\"description\":\"May help prevent kidney stones and improve iron absorption.\",\"rating\":7},{\"name\":\"Flavours\",\"description\":\"Natural flavours are preferable, but artificial ones may contain hidden allergens and chemicals.\",\"rating\":5},{\"name\":\"Taurine\",\"description\":\"An amino acid that may improve athletic performance and cognitive function.\",\"rating\":8},{\"name\":\"Sodium citrate\",\"description\":\"High in sodium, but may help regulate acidity and enhance athletic performance.\",\"rating\":6},{\"name\":\"Grape skin extract\",\"description\":\"Contains antioxidants, including resveratrol, which may have heart and brain health benefits.\",\"rating\":9},{\"name\":\"Panax ginseng flavour\",\"description\":\"Ginseng may boost energy, reduce stress, and have cognitive benefits, but long-term effects are unclear.\",\"rating\":7},{\"name\":\"Caffeine\",\"description\":\"Stimulant that can improve focus and reduce fatigue, but excessive intake may cause anxiety and insomnia.\",\"rating\":6},{\"name\":\"Sorbic acid\",\"description\":\"Preservative that may cause allergic reactions in some individuals.\",\"rating\":4},{\"name\":\"Benzoic acid\",\"description\":\"Preservative that may cause allergic reactions and is linked to hyperactivity in children.\",\"rating\":3},{\"name\":\"Niacinamide (Vitamin B3)\",\"description\":\"Important for energy metabolism and skin health, but excessive intake can cause skin flushing.\",\"rating\":7},{\"name\":\"D-Glucuronolactone\",\"description\":\"May support liver health and have antioxidant properties, but research is limited.\",\"rating\":6},{\"name\":\"Guarana seed extract\",\"description\":\"Natural source of caffeine, providing energy and potential cognitive benefits.\",\"rating\":7},{\"name\":\"Inositol\",\"description\":\"May help with anxiety and depression, and support nerve health.\",\"rating\":8},{\"name\":\"Pyridoxine hydrochloride (Vitamin B6)\",\"description\":\"Essential for brain health and metabolism, but high doses may cause nerve damage.\",\"rating\":7},{\"name\":\"Sucralose\",\"description\":\"Artificial sweetener with no calories, but may disrupt gut bacteria and blood sugar regulation.\",\"rating\":4},{\"name\":\"Riboflavin (Vitamin B2)\",\"description\":\"Important for energy production and eye health, but excessive intake can cause sensitivity to light.\",\"rating\":7},{\"name\":\"Maltodextrin\",\"description\":\"Highly processed. Dangerous for diabetics and those with gluten allergies.\",\"rating\":3},{\"name\":\"Cyanocobalamin (Vitamin B12)\",\"description\":\"Essential for nerve function and DNA synthesis, especially important for vegans and vegetarians.\",\"rating\":9}]}}"
    ];
    //_inventoryList.readInventory().then((value) => (JSON = value));
    for (var JSON in JSON) _inventoryMap.addAll(jsonDecode(JSON));
  }

  static final InventoryManager _instance =
      InventoryManager._privateConstructor();

  static final InventoryStorage _inventoryList = InventoryStorage();

  final Map<String, dynamic> _inventoryMap = {};

  factory InventoryManager() {
    return _instance;
  }

    final List<String> _inventoryImages = [];
    List<String> get inventoryImages => List.unmodifiable(_inventoryImages);


  void removeItem(String item) {
    _inventoryMap.remove(item);
    _inventoryList.writeInventory(jsonEncode(_inventoryMap));
  }

  void addItem(String item, Map<String, dynamic> entry, String imagePath) {
    _inventoryMap[item] = entry;
        _inventoryImages.add(imagePath);

    _inventoryList.writeInventory(jsonEncode(_inventoryMap));
  }

  int getItemCount() {
    return _inventoryMap.length;
  }

  String getItemNameByIndex(int index) {
    if (index < 0 || index >= _inventoryMap.length) {
      return "";
    }
    return _inventoryMap.keys.toList()[index];
  }

  String getItemLabelByIndex(int index) {
    if (index < 0 || index >= _inventoryMap.length) {
      return "";
    }
    return _inventoryMap[_inventoryMap.keys.toList()[index]]['label'];
  }

  Map<String, dynamic> getEntryByName(String name) {
    if (!_inventoryMap.containsKey(name)) {
      return {};
    }
    return _inventoryMap[name];
  }
}

// Adapted from Flutter documentation
class InventoryStorage {
  Future<String> get _localPath async {
    final directory = await getApplicationSupportDirectory();

    return directory.path;
  }

  Future<File> get _localFile async {
    final path = await _localPath;
    return File('$path/inventoryItems.json');
  }

  Future<String> readInventory() async {
    try {
      final file = await _localFile;

      // Read the file
      final contents = await file.readAsString();

      return contents;
    } catch (e) {
      // If encountering an error, return error
      return "error";
    }
  }

  Future<File> writeInventory(String JSON) async {
    final file = await _localFile;

    // Write the file
    return file.writeAsString(JSON);
  }
}
